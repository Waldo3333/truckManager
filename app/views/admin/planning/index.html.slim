/ app/views/admin/planning/index.html.slim
.container-fluid.px-4.py-8 data-controller="modal info-card"
  h1.text-3xl.font-bold.mb-6 Planning des interventions

  / SÃ©lecteur de date
  .bg-white.rounded-lg.shadow.p-4.mb-6
    = form_with url: admin_planning_path, method: :get, local: true, class: "flex gap-4 items-center", data: { turbo: false } do |f|
      label.text-sm.font-medium.text-gray-700 Date
      = f.date_field :date, value: @selected_date, class: "px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", onchange: "this.form.submit()"
      span.text-gray-500 = l(@selected_date, format: '%A %d %B %Y')
  / Layout : Sidebar + Timeline
  .flex.gap-6
    / Sidebar gauche : Chantiers Ã  planifier
    .w-80.flex-shrink-0
      .bg-white.rounded-lg.shadow.p-4.sticky style="top: 20px;"
        h2.text-lg.font-bold.mb-4 Chantiers Ã  planifier

        - if @chantiers.any?
          .space-y-2 data-chantiers-list="true"
            - @chantiers.each do |chantier|
              .bg-gray-50.border.border-gray-300.rounded.p-3.cursor-move data-chantier-id=chantier.id data-chantier-duration=chantier.duration data-chantier-name=chantier.name
                .font-medium.text-sm = chantier.name
                .text-xs.text-gray-500 = chantier.location
                .text-xs.text-blue-600.mt-1
                  = "ðŸ“ #{chantier.duration} min (#{chantier.duration_in_hours}h)"
                - if chantier.scheduled_date.present?
                  .text-xs.text-green-600.mt-1 = "ðŸ“… #{l(chantier.scheduled_date, format: :long)}"
                - else
                  .text-xs.text-gray-400.italic.mt-1 Aucune date prÃ©vue
                .text-xs.text-gray-500

                .flex.mt-2.items-center.gap-2
                  - if chantier.extra_equipment || chantier.two_operators
                    p.text-xs âš ï¸
                  - if chantier.extra_equipment
                    i class="fa-solid fa-screwdriver-wrench text-xs text-black opacity-90"
                  - if chantier.two_operators
                    i class="fa-solid fa-people-arrows text-xs text-black"

        - else
          p.text-gray-500.text-sm.italic Aucun chantier disponible

    / Timeline principale
    .flex-1.overflow-x-auto
      .bg-white.rounded-lg.shadow.p-4
        / En-tÃªte des heures
        .flex.mb-2
          .w-48.flex-shrink-0
            / Espace vide pour aligner avec les noms de camions + conducteurs
          .flex-1.flex
            - (7..18).each do |hour|
              .flex-1.text-center.text-xs.font-medium.text-gray-600.border-l.border-gray-200 style="min-width: 60px;"
                = "#{hour}h"

        / Lignes de camions
        - @trucks.each do |truck|
          - assignment = @daily_assignments[truck.id]

          .flex.border-t.border-gray-200.relative style="height: 100px;"
            / Colonne : Nom du camion + Conducteur
            .w-48.flex-shrink-0.flex.flex-col.justify-center.px-3.bg-gray-50.border-r.border-gray-200
              .font-medium.text-sm.mb-2 = truck.name

              - if assignment
                / Conducteur assignÃ©
                .flex.items-center.justify-between.bg-green-50.border.border-green-200.rounded.px-2.py-1
                  .flex.items-center.gap-1
                    span.text-xs ðŸ‘¤
                    span.text-xs.font-medium = assignment.user.email.split('@').first
                  button.text-blue-500.hover:text-blue-700.text-xs data-action="click->modal#open" data-truck-id=truck.id data-date=@selected_date data-assignment-id=assignment.id type="button"
                    | âœŽ
              - else
                / Pas de conducteur
                button.w-full.text-xs.text-gray-500.hover:text-blue-600.border.border-dashed.border-gray-300.hover:border-blue-400.rounded.px-2.py-1.transition-colors data-action="click->modal#open" data-truck-id=truck.id data-date=@selected_date type="button"
                  | + Assigner

            / Timeline des cards camions
            .flex-1.relative data-truck-timeline="true" data-truck-id=truck.id data-date=@selected_date style="min-width: 660px;"
              / Grille des heures (lignes verticales)
              - (7..18).each_with_index do |hour, index|
                .absolute.border-l.border-gray-200 style="left: #{index * 60}px; top: 0; bottom: 0; width: 60px;"

              / Interventions de ce camion
              - truck.interventions.where(date: @selected_date).each do |intervention|
                - start_hour = intervention.start_time.hour
                - start_minute = intervention.start_time.min
                - duration_minutes = intervention.duration_in_minutes

                - left_offset = ((start_hour - 7) * 60) + (start_minute * 60 / 60.0)
                - width = duration_minutes * 60 / 60.0

                .absolute.rounded.px-2.py-1.text-xs.text-white.cursor-move.group.shadow   class=(intervention.chantier.two_operators ? "bg-orange-400 border border-orange-500" : "bg-blue-400 border border-blue-500") style="left: #{left_offset}px; width: #{width}px; top: 15px; height: 70px; overflow: hidden;"  data-intervention-id=intervention.id data-chantier-id=intervention.chantier_id data-chantier-duration=intervention.chantier.duration data-action="mousedown->info-card#startClick click->info-card#open"
                  .flex.gap-1
                    .font-medium.truncate = intervention.chantier.name
                    - if intervention.chantier.extra_equipment
                      i class="fa-solid fa-screwdriver-wrench text-xs text-gray-300 opacity-90" âš ï¸
                  .text-xs.opacity-90
                    = "#{intervention.start_time.strftime('%H:%M')} - #{intervention.end_time.strftime('%H:%M')}"
                  .text-xs.opacity-90
                    = "#{intervention.chantier.description.to_s.first(20)}"
                  button.absolute.top-1.right-1.text-white.hover:text-red-200.opacity-0.group-hover:opacity-100.transition-opacity data-delete-intervention=intervention.id type="button"
                    | Ã—
  = render 'admin/chantiers/info_modal'

  / Modal d'assignation
  #assignment-modal.hidden.fixed.inset-0.flex.items-center.justify-center.z-50 class="bg-black/40"
    .bg-white.rounded-lg.shadow-xl.p-6.w-96
      h3.text-xl.font-bold.mb-4 Assigner un conducteur

      = form_with model: [:admin, DailyAssignment.new], local: true, id: "assignment-form", class: "space-y-4" do |f|
        = f.hidden_field :truck_id, id: "modal-truck-id"
        = f.hidden_field :date, id: "modal-date"

        .space-y-2
          = f.label :user_id, "Conducteur", class: "block text-sm font-medium text-gray-700"
          = f.select :user_id, @available_users.map { |u| [u.email, u.id] }, { include_blank: "SÃ©lectionner un conducteur" }, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"

        .flex.justify-end.gap-2
          button.px-4.py-2.text-gray-700.bg-gray-200.rounded.hover:bg-gray-300 type="button" data-action="click->modal#close"
            | Annuler
          = f.submit "Assigner", class: "px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"


/ Styles additionnels
css:
  [data-truck-timeline] {
    background: repeating-linear-gradient(
      to right,
      transparent,
      transparent 59px,
      #e5e7eb 59px,
      #e5e7eb 60px
    );
  }
